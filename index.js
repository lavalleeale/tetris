(()=>{var st={rotations:[[{x:0,y:2},{x:1,y:2},{x:2,y:2},{x:3,y:2}],[{x:2,y:0},{x:2,y:1},{x:2,y:2},{x:2,y:3}],[{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:3,y:1}],[{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:1,y:3}]],color:"rgba(117,  251, 253)",startingPos:{x:3,y:-2}},it={rotations:[[{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:2,y:0}],[{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}],[{x:0,y:2},{x:0,y:1},{x:1,y:1},{x:2,y:1}],[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2}]],color:"rgb(243, 174, 61)",startingPos:{x:3,y:0}},at={rotations:[[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}],[{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:0}],[{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:2,y:2}],[{x:0,y:2},{x:1,y:2},{x:1,y:1},{x:1,y:0}]],color:"rgb(0,  0, 245)",startingPos:{x:3,y:0}},lt={rotations:[[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:0}],[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:0}],[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:0}],[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:0}]],color:"rgb(255, 255, 84)",startingPos:{x:4,y:0}},xt={rotations:[[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1}],[{x:2,y:0},{x:2,y:1},{x:1,y:1},{x:1,y:2}],[{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:2,y:2}],[{x:1,y:0},{x:1,y:1},{x:0,y:1},{x:0,y:2}]],color:"rgb(234, 51, 35)",startingPos:{x:3,y:0}},ct={rotations:[[{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:0}],[{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:1}],[{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}],[{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:0,y:1}]],color:"rgb(140, 26, 245)",startingPos:{x:3,y:0}},dt={rotations:[[{x:0,y:2},{x:1,y:2},{x:1,y:1},{x:2,y:1}],[{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}],[{x:0,y:1},{x:1,y:1},{x:1,y:0},{x:2,y:0}],[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]],color:"rgb(117, 251, 76)",startingPos:{x:3,y:-1}},F={I:st,J:at,L:it,O:lt,S:dt,T:ct,Z:xt};var C=()=>{let t=Object.values(F).map(e=>({shape:e,rotation:0,position:{x:e.startingPos.x,y:e.startingPos.y}}));return pt(t),t};function pt(t){for(let e=t.length-1;e>0;e--){let o=Math.floor(Math.random()*(e+1));[t[e],t[o]]=[t[o],t[e]]}}var q=()=>{let t=r.shape.rotations[r.rotation%4].map(i=>({x:i.x+r.position.x,y:i.y+r.position.y})),e=t.sort((i,l)=>l.y-i.y)[0],o=19-e.y;for(let i=0;i<4;i++){let l=t[i];for(let y=Math.max(l.y+1,0);y<20;y++)if(p[y][l.x]!==null){o=Math.min(o,y-l.y-1);break}}return o},z=()=>{if(D){let t={shape:r.shape,position:{x:r.shape.startingPos.x,y:r.shape.startingPos.y},rotation:0};if(b===null)N(t),S(f.pop()),f.length===0&&f.push(...C()),M();else{let e=b;N(r),S(e)}X(),H(!1)}};var E=document.getElementById("canvas"),$=document.getElementById("pauseMenu"),g=E.width/6,h=E.width-g*2,u=E.height,B=g-10,w=g+h+9,s=E.getContext("2d"),p=Array(20).fill(null).map(()=>Array(10).fill(null)),f=C(),r=f.pop(),b=null,R=0,J=!0,T=!1,D=!0,I=0,Q=0,K=()=>{T?(I=performance.now()+Q,E.style.display="inline-block",$.style.display="none"):(Q=performance.now()-I,E.style.display="none",$.style.display="inline-block"),T=!T},O=()=>{I=performance.now()},H=t=>{D=t},Z=()=>{J=!1},G=()=>{R++},U=t=>{p=t},S=t=>{r=t},N=t=>{b=t};var V=()=>{s.font="28px Arial",s.strokeRect(1,1,B,u-2);let t=s.measureText("Hold");s.fillText("Hold",(B-t.width)/2,t.fontBoundingBoxAscent),s.strokeRect(w,1,B,u-2);let e=s.measureText("Next");s.fillText("Next",w+(B-e.width)/2,e.fontBoundingBoxAscent),W(),M()},W=()=>{s.fillStyle="black",s.font="16px Arial";let t=s.measureText(`Cleared: ${R}`);s.clearRect(w+(B-t.width)/2,u-t.fontBoundingBoxAscent*2,t.width,t.fontBoundingBoxAscent),s.fillText(`Cleared: ${R}`,w+(B-t.width)/2,u-t.fontBoundingBoxAscent)},M=()=>{let t=f[f.length-1],e=t.shape.rotations[0],o=(B-10)/4,i=Math.max(...e.map(y=>y.x)),l=5+o/2*(3-i);s.clearRect(w+5,50,o*4,o*4),s.fillStyle=t.shape.color,e.forEach(y=>{s.fillRect(w+l+o*y.x,50+o*y.y,o-2,o-2)})},X=()=>{let t=(B-10)/4,e=Math.max(...b.shape.rotations[0].map(i=>i.x)),o=5+t/2*(3-e);s.clearRect(5,50,t*4,t*4),s.fillStyle=b.shape.color,b.shape.rotations[0].forEach(i=>{s.fillRect(o+t*i.x,50+t*i.y,t-2,t-2)})},j=()=>{s.clearRect(g,0,h,u);for(let e=0;e<10;e++)for(let o=0;o<20;o++)s.lineWidth=1,s.strokeRect(e*(h/10)+g,o*(u/20),h/10,u/20);for(let e=0;e<p.length;e++)for(let o=0;o<p[e].length;o++){let i=p[e][o];i!==null&&(s.fillStyle=i,s.fillRect(o*(h/10)+1+g,e*(u/20)+1,h/10-2,u/20-2))}s.fillStyle=r.shape.color,r.shape.rotations[r.rotation%4].forEach(e=>{s.fillRect((e.x+r.position.x)*(h/10)+1+g,(e.y+r.position.y)*(u/20)+1,h/10-2,u/20-2)}),s.globalAlpha=.5;let t=q();r.shape.rotations[r.rotation%4].forEach(e=>{s.fillRect((e.x+r.position.x)*(h/10)+1+g,(e.y+r.position.y+t)*(u/20)+1,h/10-2,u/20-2)}),s.globalAlpha=1};var Y={left:"KeyA",right:"KeyD",down:"KeyS",rotate:"KeyW",rotateBack:"KeyE",hold:"KeyQ",drop:"Space",pause:"Escape"},n=localStorage.getItem("controls")?JSON.parse(localStorage.getItem("controls")):{...Y},_=()=>{n={...Y},localStorage.setItem("controls",JSON.stringify(n))},k={},tt=()=>{document.addEventListener("keydown",t=>{k[t.code]=0}),document.addEventListener("keyup",t=>{delete k[t.code]})};var L=()=>{let t=r.shape.rotations[(r.rotation+1)%4];for(let e=0;e<4;e++){let o=t[e];if(p[r.position.y+o.y]!==void 0&&p[r.position.y+o.y][r.position.x+o.x]!==null)return}r.rotation++},v=(t,e)=>{let o=r.shape.rotations[r.rotation%4];for(let i=0;i<o.length;i++){let l=o[i];if(e+l.y+r.position.y>=20)return et(),1;if(p[r.position.y+l.y+e]!==void 0&&typeof p[r.position.y+l.y+e][r.position.x+l.x+t]=="string")return l.y+r.position.y+e<=1?(alert("fail"),Z(),3):e===1?(et(),1):2;if(t+l.x+r.position.x<0||t+l.x+r.position.x>=10)return 2}return r.position.x+=t,r.position.y+=e,0},et=()=>{let t=[];for(let e=0;e<4;e++){let o=r.shape.rotations[r.rotation%4][e];p[o.y+r.position.y][o.x+r.position.x]=r.shape.color,t.includes(o.y+r.position.y)||t.push(o.y+r.position.y)}S(f.pop()),f.length===0&&f.push(...C()),M(),t.sort().forEach(e=>{for(let o=0;o<10;o++){if(p[e][o]===null){t=t.slice(1);break}o===9&&(G(),W(),U([Array(10).fill(null),...p.slice(0,e),...p.slice(e+1)]))}}),H(!0)};var m=null,ot=()=>{let t=document.getElementById("leftButton"),e=document.getElementById("rightButton"),o=document.getElementById("downButton"),i=document.getElementById("rotateButton"),l=document.getElementById("rotateBackButton"),y=document.getElementById("holdButton"),A=document.getElementById("dropButton"),P=document.getElementById("pauseButton"),x=document.getElementById("resetButton"),nt=document.getElementById("returnButton");t.addEventListener("click",()=>{t.innerText="Press Any Button",m=c.left}),e.addEventListener("click",()=>{e.innerText="Press Any Button",m=c.right}),o.addEventListener("click",()=>{o.innerText="Press Any Button",m=c.down}),i.addEventListener("click",()=>{i.innerText="Press Any Button",m=c.rotate}),l.addEventListener("click",()=>{l.innerText="Press Any Button",m=c.rotateBack}),y.addEventListener("click",()=>{y.innerText="Press Any Button",m=c.hold}),A.addEventListener("click",()=>{A.innerText="Press Any Button",m=c.drop}),P.addEventListener("click",()=>{P.innerText="Press Any Button",m=c.pause}),t.innerText=a(n.left),e.innerText=a(n.right),o.innerText=a(n.down),i.innerText=a(n.rotate),l.innerText=a(n.rotateBack),y.innerText=a(n.hold),A.innerText=a(n.drop),P.innerText=a(n.pause),document.addEventListener("keydown",d=>{if(m!==null){switch(m){case c.left:n.left=d.code,t.innerText=a(d.code);break;case c.right:n.right=d.code,e.innerText=a(d.code);break;case c.down:n.down=d.code,o.innerText=a(d.code);break;case c.rotate:n.rotate=d.code,i.innerText=a(d.code);break;case c.rotateBack:n.rotateBack=d.code,l.innerText=a(d.code);break;case c.hold:n.hold=d.code,y.innerText=a(d.code);break;case c.drop:n.drop=d.code,A.innerText=a(d.code);break;case c.pause:n.pause=d.code,P.innerText=a(d.code);break}localStorage.setItem("controls",JSON.stringify(n)),m=null}}),x.addEventListener("click",()=>{_(),t.innerText=a(n.left),e.innerText=a(n.right),o.innerText=a(n.down),i.innerText=a(n.rotate),l.innerText=a(n.rotateBack),y.innerText=a(n.hold),A.innerText=a(n.drop),P.innerText=a(n.pause)}),nt.addEventListener("click",()=>{m=null,K()})},a=t=>t.replace("Key","").replace("Arrow",""),c=(x=>(x[x.left=0]="left",x[x.right=1]="right",x[x.down=2]="down",x[x.rotate=3]="rotate",x[x.rotateBack=4]="rotateBack",x[x.hold=5]="hold",x[x.drop=6]="drop",x[x.pause=7]="pause",x))(c||{});var ut=1e3,rt=t=>{J&&!T&&(Object.values(n).forEach(e=>{if(k[e]<t)switch(k[e]===0?k[e]=t+170:k[e]=t+50,e){case n.left:v(-1,0);break;case n.right:v(1,0);break;case n.down:O(),v(0,1);break;case n.rotate:L();break;case n.rotateBack:L(),L(),L();break;case n.drop:for(O();v(0,1)!==1;);break;case n.hold:z();break;case n.pause:K();break}}),t>I+ut&&!T&&(v(0,1),O()),j()),window.requestAnimationFrame(rt)};V();j();tt();ot();window.requestAnimationFrame(rt);})();
